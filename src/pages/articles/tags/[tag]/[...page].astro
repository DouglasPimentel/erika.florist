---
import ArticleListLayout from "$layouts/ArticleListLayout.astro"
import { postProcessArticle, Article } from "$data/articles"

export async function getStaticPaths({ paginate }) {
  let articles = (await Astro.fetchContent("/content/articles/**/*.md")) as Article[]
  articles = articles
    .map((article) => postProcessArticle(article))
    .sort((a, b) => {
      return b.date.getTime() - a.date.getTime()
    })

  const tagList = new Set()
  articles.forEach((article) => {
    article.tags.forEach((tag) => {
      tagList.add(tag)
    })
  })

  return Array.from(tagList).map((tag) => {
    const filteredArticles = articles.filter((article) => article.tags.includes(tag))
    return paginate(filteredArticles, { params: { tag }, pageSize: 6 })
  })
}

const { page } = Astro.props
const tag = Astro.request.params.tag
---

<ArticleListLayout {page} title={"Articles tagged " + tag} />
