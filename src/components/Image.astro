---
import { getPlaceholderURL } from "$utils";
import type { ImageMetadata } from "astro";
import type { HTMLAttributes } from "astro/types";
import { getImage } from "astro:assets";

export interface Props extends Omit<HTMLAttributes<"img">, "src"> {
  src: ImageMetadata;
  alt: string;
  imageWidth?: number;
  imageHeight?: number;
}

const originalFormat = await getImage({
  src: Astro.props.src,
  width: Astro.props.imageWidth,
  height: Astro.props.imageHeight,
  format: Astro.props.src.format,
});
const formats = ["avif", "webp"];
const sources: Record<string, Awaited<ReturnType<typeof getImage>>> = {};
for (let format of formats) {
  sources[format] = await getImage({
    src: Astro.props.src,
    width: Astro.props.imageWidth,
    height: Astro.props.imageHeight,
    format: format,
  });
}

const { src, imageHeight, imageWidth, ...passedAttributes } = Astro.props;
if (!passedAttributes.width) {
  passedAttributes.width = originalFormat.attributes.width;
}
if (!passedAttributes.height) {
  passedAttributes.height = originalFormat.attributes.height;
}
const { width, height, ...attributes } = originalFormat.attributes;
---

<picture>
  {
    Object.values(sources).map((source) => (
      <source srcset={source.src} type={"image/" + source.options.format} />
    ))
  }
  <img
    src={originalFormat.src}
    style={`background-size: cover;background-image: url(${await getPlaceholderURL(
      Astro.props.src.src,
      Astro.props.src.width,
      Astro.props.src.height,
    )});image-rendering:auto;`}
    onload="this.style.backgroundImage='none';this.style.removeProperty('image-rendering');"
    {...passedAttributes}
    {...attributes}
  />
</picture>
